<html>
<head>
  <meta charset=utf-8 />
  <title>Esri Leaflet Quickstart</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
    <link rel="stylesheet" type="text/css" href="map.css">
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
    integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin=""></script>


    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
    integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
    crossorigin=""></script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>


  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
  </style>
</head>
<body>

<div id="map"></div>

<script>


  var map = L.map("map").setView([0, 0], 12);
  L.esri.basemapLayer("Streets").addTo(map);

  

  var group = L.featureGroup();
  group.addTo(map);

  var stops = L.markerClusterGroup();

  var out_routes_p = $.getJSON(`https://logistics.arcgis.com/arcgis/rest/services/World/VehicleRoutingProblem/GPServer/SolveVehicleRoutingProblem/jobs/${sessionStorage.getItem("jobid")}/results/out_routes?f=json&token=${sessionStorage.getItem("token")}`);

  var out_stops_p = $.getJSON(`https://logistics.arcgis.com/arcgis/rest/services/World/VehicleRoutingProblem/GPServer/SolveVehicleRoutingProblem/jobs/${sessionStorage.getItem("jobid")}/results/out_stops?f=json&token=${sessionStorage.getItem("token")}`);

  var in_orders_p = $.getJSON(`https://logistics.arcgis.com/arcgis/rest/services/World/VehicleRoutingProblem/GPServer/SolveVehicleRoutingProblem/jobs/${sessionStorage.getItem("jobid")}/inputs/orders?f=json&token=${sessionStorage.getItem("token")}`);

  var in_depots_p = $.getJSON(`https://logistics.arcgis.com/arcgis/rest/services/World/VehicleRoutingProblem/GPServer/SolveVehicleRoutingProblem/jobs/${sessionStorage.getItem("jobid")}/inputs/depots?f=json&token=${sessionStorage.getItem("token")}`);


  function makeColor() {
  	var color;
	var r = Math.floor(Math.random() * 255);
	var g = Math.floor(Math.random() * 255);
	var b = Math.floor(Math.random() * 255);
	color= "rgb("+r+" ,"+g+","+ b+")"; 
	return color;
  }

  function addGeometry(orders, depots, stops) {
    for (i = 0; i < stops.features.length; i++) {
      for (j = 0; j < orders.features.length; j++) {
        if (stops.features[i].properties.Name == orders.features[j].properties.Name) {stops.features[i].geometry = orders.features[j].geometry}
      }
      for (k = 0; k < depots.features.length; k ++) {
        if (stops.features[i].properties.Name == depots.features[k].properties.Name) {stops.features[i].geometry = depots.features[k].geometry}
      }
    }
  }

  function addToMap(geoJson, layer, color) {
    L.geoJson(geoJson, {
      pointToLayer: function(feature, latlng) {
        if (feature.geometry.type == "Point") {return L.circleMarker(latlng, {radius, 15})};
      },
      style: function(feature) {
      	console.log(feature);
      	if (icon) {
    		return {stroke: false, fill: true, color: color};
      	} else {
      	return {color: makeColor()};
      	}	
      },
      onEachFeature: function(feature, layer) {
        var popupContent = "<table>";
        for (var p in feature.properties) {
          (typeof feature.properties[p] === "number") ? 
            popupContent += "<tr><td>" + p + "</td><td>" + String(feature.properties[p]).substring(0,6) + "</td></tr>" : 
            popupContent += "<tr><td>" + p + "</td><td>" + feature.properties[p] + "</td></tr>"
        }
        popupContent += "</table>"
        layer.bindPopup(popupContent);
        //if (icon) {layer.setIcon(icon)}
      }
    }).addTo(layer)
  };

  out_routes_p.done(function(data) {
    addToMap(L.esri.Util.arcgisToGeoJSON(data.value), group, null);
    map.fitBounds(group.getBounds());
  });

  in_depots_p.done(function(data) {
    addToMap(L.esri.Util.arcgisToGeoJSON(data.value), group, "#de2d26");
  });

  in_orders_p.done(function(data) {
    addToMap(L.esri.Util.arcgisToGeoJSON(data.value), group, "#377eb8");
  });

  Promise.all([in_orders_p, in_depots_p, out_stops_p]).then(function(lst){
    var in_orders = L.esri.Util.arcgisToGeoJSON(lst[0].value);
    var in_depots = L.esri.Util.arcgisToGeoJSON(lst[1].value);
    var out_stops = L.esri.Util.arcgisToGeoJSON(lst[2].value);
    addGeometry(in_orders, in_depots, out_stops);
    addToMap(out_stops, stops, "#4daf4a");
    
  });

  var overlayStops = {
      "Stops" : stops
  }; 
  L.control.layers(null, overlayStops).addTo(map);

  function getColor(d) {
    return d === 'Orders'  ? "#de2d26" :
           d === 'Depots'  ? "#377eb8" :
           d === 'Stops' ? "#4daf4a" :
           d === 'Roadside Hazards' ? "#984ea3" :
                        "#ff7f00";
  };



  var legend = L.control({position: 'bottomleft'});
  legend.onAdd = function(map) {

    var div = L.DomUtil.create('div', 'info legend');
    labels = ['<strong>Categories</strong>'],
    categories = ['Orders','Depots','Stops'];

    for (var i = 0; i < categories.length; i++) {

            div.innerHTML += 
            labels.push(
                '<i class="circle" style="background:' + getColor(categories[i]) + '"></i>' +
            (categories[i] ? categories[i] : '+'));

        }
        div.innerHTML = labels.join('<br>');
    return div;
  };
  legend.addTo(map);


</script>

</body>
</html>